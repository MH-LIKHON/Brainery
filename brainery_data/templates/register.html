{% extends "base.html" %}

{% block content %}

<style>
    /* =======================================================
   REGISTER PAGE
   ======================================================= */

    /* -------------------------------
   Global Resets
   ------------------------------- */
    /* Reset default margins and paddings */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Arial', sans-serif;
    }

    /* Body Styling */
    body {
        background: #f8f9fa;
    }

    /* -------------------------------
   Page Layout
   ------------------------------- */
    /* Page container for register form */
    .register-container {
        max-width: 700px;
        margin: 50px auto;
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
    }

    /* Smooth fade-in effect */
    .register-container.show {
        opacity: 1;
        transform: translateY(0);
    }

    .register-container.hidden {
        opacity: 0;
        transform: translateY(-10px);
    }

    /* -------------------------------
   Titles
   ------------------------------- */
    /* Register Page Title */
    .register-container h2 {
        font-weight: bold;
        margin-bottom: 20px;
    }

    /* -------------------------------
   Package Selection Layout
   ------------------------------- */
    /* Package selection container */
    .package-selection {
        display: flex;
        justify-content: space-between;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    /* -------------------------------
   Package Cards
   ------------------------------- */
    /* Individual package card */
    .package {
        flex: 1;
        padding: 20px;
        background: #fff;
        border: 2px solid #20c997;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease-in-out;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        text-align: center;
        min-width: 200px;
        position: relative;
    }

    /* Hover effect & selection */
    .package:hover,
    .package.selected {
        background: #20c997;
        color: white;
        transform: scale(1.05);
        box-shadow: 0px 6px 15px rgba(0, 0, 0, 0.2);
    }

    /* Small pulse effect when selected */
    .package.selected::after {
        content: "✔";
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 20px;
        font-weight: bold;
        color: white;
    }

    /* -------------------------------
   Form Sections
   ------------------------------- */
    /* Smooth fade-in effect */
    .step-section {
        display: none;
        opacity: 0;
        transition: opacity 0.4s ease-in-out;
    }

    .step-section.active {
        display: block;
        opacity: 1;
    }

    /* -------------------------------
   Form Input Fields
   ------------------------------- */
    /* Form group wrapper */
    .form-group {
        margin-bottom: 15px;
        position: relative;
    }

    /* Input Labels */
    label {
        font-weight: bold;
        display: block;
    }

    /* Input Fields */
    input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        transition: border 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
    }

    /* Input focus effect */
    input:focus {
        border-color: #20c997;
        box-shadow: 0px 0px 8px rgba(32, 201, 151, 0.3);
        outline: none;
    }

    /* -------------------------------
   Payment Section
   ------------------------------- */
    /* Smooth fade-in effect */
    .payment-section {
        display: none;
        opacity: 0;
        transition: opacity 0.4s ease-in-out;
    }

    .payment-section.active {
        display: block;
        opacity: 1;
    }

    /* -------------------------------
   Promo Code Section
   ------------------------------- */
    /* Promo code input */
    .promo-code input {
        width: 70%;
        display: inline-block;
    }

    /* Promo code apply button */
    .promo-code button {
        width: 28%;
        background: #20c997;
        color: white;
        border: none;
        padding: 8px;
        cursor: pointer;
        transition: background 0.3s ease-in-out;
    }

    /* Hover effect */
    .promo-code button:hover {
        background: #198754;
    }

    /* Promo Message */
    #promo-message {
        margin-top: 5px;
        font-size: 14px;
        transition: opacity 0.3s ease-in-out, color 0.3s ease-in-out;
    }

    /* -------------------------------
   Submit Button
   ------------------------------- */
    /* Main submit button */
    .submit-btn {
        background: #20c997;
        color: white;
        border: none;
        padding: 12px;
        width: 100%;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
        border-radius: 5px;
        transition: background 0.3s ease-in-out, transform 0.2s ease-in-out;
    }

    /* Hover effect */
    .submit-btn:hover {
        background: #198754;
        transform: scale(1.02);
    }

    /* Click effect */
    .submit-btn:active {
        transform: scale(0.98);
    }

    /* Loading Spinner for Button */
    .spinner {
        width: 15px;
        height: 15px;
        border: 2px solid white;
        border-top-color: transparent;
        border-radius: 50%;
        display: inline-block;
        animation: spin 0.6s linear infinite;
        margin-right: 5px;
    }

    /* Spinner for Button */
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* -------------------------------
   Funny Confirmation Message
   ------------------------------- */
    /* Hidden by default */
    .success-message {
        display: none;
        font-size: 22px;
        font-weight: bold;
        text-align: center;
        color: #20c997;
        padding: 50px;
        transition: opacity 0.3s ease-in-out;
    }

    /* -------------------------------
   Mobile & Tablet View (Responsive)
   ------------------------------- */
    /* Adjust Navbar for Mobile (screens smaller than 768px) */
    @media (max-width: 768px) {
        .register-container {
            max-width: 95%;
            padding: 20px;
        }

        .package-selection {
            flex-direction: column;
            gap: 10px;
        }

        .package {
            width: 100%;
        }

        input {
            font-size: 14px;
        }

        .submit-btn {
            font-size: 14px;
            padding: 10px;
        }
    }

    /* Adjust Navbar for Mobile (screens smaller than 576px) */
    @media (max-width: 480px) {
        .register-container {
            padding: 15px;
        }

        h2 {
            font-size: 22px;
        }

        .submit-btn {
            font-size: 14px;
        }
    }
</style>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div class="flash-messages">
    {% for category, message in messages %}
    <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %}
</div>
{% endif %}
{% endwith %}

<!-- Register Page Container -->
<div class="register-container" id="register-form">
    <h2>Choose Your Brainery Plan</h2>

    <!-- Package Selection -->
    <div class="package-selection">
        <div class="package" data-price="10" data-name="Weekly Plan">
            <h4>Weekly Plan - £10</h4>
            <ul>
                <li>📚 Access to all courses</li>
                <li>📅 7-day validity</li>
                <li>💬 Community Support</li>
            </ul>
        </div>
        <div class="package" data-price="30" data-name="Monthly Plan">
            <h4>Monthly Plan - £30</h4>
            <ul>
                <li>📚 Access to all courses</li>
                <li>📅 30-day validity</li>
                <li>💬 Priority Support</li>
            </ul>
        </div>
        <div class="package" data-price="100" data-name="Annual Plan">
            <h4>Annual Plan - £100</h4>
            <ul>
                <li>📚 Access to all courses</li>
                <li>📅 1-year validity</li>
                <li>🎓 Certification on Completion</li>
            </ul>
        </div>
    </div>

    <!-- Personal Info Step -->
    <form method="POST" action="{{ url_for('register.register_user') }}" class="step-section" id="personal-info">
        {{ form.hidden_tag() }}

        <h4>Tell us about yourself</h4>

        <div class="form-group">
            <label for="first-name">First Name</label>
            {{ form.first_name(class="form-control", required=True) }}
        </div>

        <div class="form-group">
            <label for="last-name">Last Name</label>
            {{ form.last_name(class="form-control", required=True) }}
        </div>

        <div class="form-group">
            <label for="dob">Date of Birth</label>
            {{ form.dob(class="form-control", required=True) }}
        </div>

        <div class="form-group">
            <label for="email">Email Address</label>
            {{ form.email(class="form-control", required=True) }}
        </div>

        <div class="form-group">
            <label for="phone">Phone Number</label>
            {{ form.phone(class="form-control", required=True) }}
        </div>

        <h5>Billing Address</h5>

        <div class="form-group">
            <label for="address-line1">Address Line 1</label>
            {{ form.address_line1(class="form-control", required=True) }}
        </div>

        <div class="form-group">
            <label for="address-line2">Address Line 2 (Optional)</label>
            {{ form.address_line2(class="form-control") }}
        </div>

        <div class="form-group">
            <label for="city">City</label>
            {{ form.city(class="form-control", required=True) }}
        </div>

        <div class="form-group">
            <label for="country">Country</label>
            {{ form.country(class="form-control", required=True) }}
        </div>

        <div class="form-group">
            <label for="postcode">Postcode</label>
            {{ form.postcode(class="form-control", required=True) }}
        </div>

        <h5>Set Your Account Password</h5>
        <div class="form-group">
            <label for="password">Password</label>
            {{ form.password(class="form-control", required=True) }}
        </div>

        <div class="form-group">
            <label for="confirm-password">Confirm Password</label>
            {{ form.confirm_password(class="form-control", required=True) }}
        </div>

        <button type="button" class="submit-btn" id="next-payment">Next: Payment</button>
    </form>

    <!-- Payment Section -->
    <form method="POST" id="payment-form" class="step-section payment-section">
        <h4>Enter Payment Details</h4>

        <div class="form-group">
            <label>Card Number</label>
            <input type="text" name="card_number" class="form-control" required>
        </div>

        <div class="form-group">
            <label>Expiry Date</label>
            <input type="text" name="expiry_date" class="form-control" placeholder="MM/YY" required>
        </div>

        <div class="form-group">
            <label>CVV</label>
            <input type="text" name="cvv" class="form-control" required>
        </div>

        <!-- Promo Code -->
        <div class="promo-code">
            <input type="text" id="promo-code" placeholder="Enter promo code">
            <button type="button" onclick="applyPromoCode()">Apply</button>
            <p id="promo-message"></p>
        </div>

        <button type="submit" class="submit-btn" id="payment-submit-btn">Complete Registration</button>
    </form>

    <!-- Funny Success Message -->
    <div class="success-message" id="success-message">
        <h2>🎉 Woohoo! You’re now officially part of the Brainery Family! 🎓</h2>
        <p>📬 Check your email for your account activation link.</p>
        <p>🤖 If you don’t see it, maybe it’s lost in the <strong>Matrix</strong> (or spam folder).</p>
        <p>🚀 Happy Learning!</p>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Step 1: Handle Plan Selection
            document.querySelectorAll(".package").forEach(item => {
                item.addEventListener("click", function () {
                    document.querySelectorAll(".package").forEach(p => p.classList.remove("selected"));
                    this.classList.add("selected");

                    let personalInfo = document.getElementById("personal-info");
                    personalInfo.style.display = "block";
                    setTimeout(() => {
                        personalInfo.style.opacity = 1;
                    }, 200);

                    let existingPlanInput = document.querySelector("input[name='selected_plan']");
                    if (existingPlanInput) {
                        existingPlanInput.remove();
                    }

                    let planInput = document.createElement("input");
                    planInput.type = "hidden";
                    planInput.name = "selected_plan";
                    planInput.value = this.dataset.name + " - £" + this.dataset.price;
                    document.getElementById("personal-info").appendChild(planInput);
                });
            });

            // Step 2: Ensure a plan is selected before proceeding
            document.getElementById("next-payment").addEventListener("click", function (event) {
                event.preventDefault();

                let selectedPlan = document.querySelector(".package.selected");
                if (!selectedPlan) {
                    alert("Please select a plan before proceeding.");
                    return;
                }

                let requiredFields = document.querySelectorAll("#personal-info input[required]");
                let emptyFields = Array.from(requiredFields).filter(input => input.value.trim() === "");

                if (emptyFields.length > 0) {
                    alert("Please fill in all required fields before proceeding.");
                    return;
                }

                document.getElementById("personal-info").style.opacity = 0;
                setTimeout(() => {
                    document.getElementById("personal-info").style.display = "none";
                    document.getElementById("payment-form").style.display = "block";
                    setTimeout(() => {
                        document.getElementById("payment-form").style.opacity = 1;
                    }, 200);
                }, 200);
            });

            // Step 3: Promo Code Logic
            function applyPromoCode() {
                const promoCodeInput = document.getElementById("promo-code").value.trim();
                const promoMessage = document.getElementById("promo-message");
                const submitBtn = document.querySelector("#payment-form .submit-btn");

                // Payment fields
                let cardNumber = document.querySelector('input[name="card_number"]');
                let expiryDate = document.querySelector('input[name="expiry_date"]');
                let cvv = document.querySelector('input[name="cvv"]');

                if (promoCodeInput === "CI25MP3") {
                    // ✅ Promo code applied → Disable payment fields (greyed out)
                    promoMessage.innerText = "✅ Promo applied! No payment required.";
                    promoMessage.style.color = "green";

                    // Grey out fields by disabling them
                    cardNumber.disabled = true;
                    expiryDate.disabled = true;
                    cvv.disabled = true;

                    // Add greyed-out styling
                    cardNumber.style.backgroundColor = "#e9ecef";
                    expiryDate.style.backgroundColor = "#e9ecef";
                    cvv.style.backgroundColor = "#e9ecef";

                    // Change button text to "Complete Registration"
                    submitBtn.innerText = "Complete Registration";
                    submitBtn.disabled = false;
                } else {
                    // ❌ Invalid promo code → Show error and re-enable fields
                    promoMessage.innerText = "❌ Invalid promo code.";
                    promoMessage.style.color = "red";

                    // Re-enable payment fields
                    cardNumber.disabled = false;
                    expiryDate.disabled = false;
                    cvv.disabled = false;

                    // Reset greyed-out styling
                    cardNumber.style.backgroundColor = "";
                    expiryDate.style.backgroundColor = "";
                    cvv.style.backgroundColor = "";

                    submitBtn.innerText = "Complete Registration";
                }
            }

            // Step 3.1: Apply promo code on "Enter" key press
            document.getElementById("promo-code").addEventListener("keypress", function (event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    applyPromoCode();
                }
            });

            // Step 3.2: Apply promo code when clicking "Apply" button
            document.querySelector(".promo-code button").addEventListener("click", function () {
                applyPromoCode();
            });

            // Step 3.3: Restore Payment Fields if Promo Code is Removed
            document.getElementById("promo-code").addEventListener("input", function () {
                const promoMessage = document.getElementById("promo-message");
                const submitBtn = document.querySelector("#payment-form .submit-btn");

                let cardNumber = document.querySelector('input[name="card_number"]');
                let expiryDate = document.querySelector('input[name="expiry_date"]');
                let cvv = document.querySelector('input[name="cvv"]');

                if (this.value.trim() !== "CI25MP3") {
                    // Reset promo message
                    promoMessage.innerText = "";

                    // Re-enable payment fields
                    cardNumber.disabled = false;
                    expiryDate.disabled = false;
                    cvv.disabled = false;

                    // Reset greyed-out styling
                    cardNumber.style.backgroundColor = "";
                    expiryDate.style.backgroundColor = "";
                    cvv.style.backgroundColor = "";

                    submitBtn.innerText = "Complete Registration";
                }
            });

            // Step 4: Validate Payment Details and Submit Form
            document.getElementById("payment-form").addEventListener("submit", function (event) {
                event.preventDefault();

                let promoCode = document.getElementById("promo-code").value.trim();
                let submitButton = document.querySelector("#payment-form .submit-btn");

                if (promoCode !== "CI25MP3") {
                    let cardNumber = document.querySelector('input[name="card_number"]').value.trim();
                    let expiryDate = document.querySelector('input[name="expiry_date"]').value.trim();
                    let cvv = document.querySelector('input[name="cvv"]').value.trim();

                    if (!/^\d{16}$/.test(cardNumber)) {
                        alert("Please enter a valid 16-digit card number.");
                        return;
                    }

                    // **Updated Expiry Date Validation (Dynamic)**
                    let currentYear = new Date().getFullYear().toString().slice(-2);
                    const expiryRegex = new RegExp(`^(0[1-9]|1[0-2])\/(${currentYear}|[3-9][0-9])$`);
                    if (!expiryRegex.test(expiryDate)) {
                        alert("Please enter a valid expiry date in MM/YY format (e.g., 08/27).");
                        return;
                    }

                    if (!/^\d{3,4}$/.test(cvv)) {
                        alert("Please enter a valid 3 or 4-digit CVV.");
                        return;
                    }
                }

                // Step 5: Show loading effect before success message
                submitButton.innerHTML = "<span class='spinner'></span> Processing...";
                submitButton.disabled = true;

                setTimeout(() => {
                    document.getElementById("payment-form").style.opacity = 0;
                    setTimeout(() => {
                        document.getElementById("payment-form").style.display = "none";
                        document.getElementById("success-message").style.display = "block";
                        document.getElementById("success-message").style.opacity = 1;
                    }, 200);
                }, 2000);
            });
        });
    </script>

    {% endblock %}